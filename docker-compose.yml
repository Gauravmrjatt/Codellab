services:
  postgres:
    image: postgres:15-alpine
    container_name: codellab-postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-codellab}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-codellab_password}
      POSTGRES_DB: ${POSTGRES_DB:-codellab}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  web:
    build: ./codellab
    container_name: codellab-web
    restart: always
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-codellab}:${POSTGRES_PASSWORD:-codellab_password}@postgres:5432/${POSTGRES_DB:-codellab}?schema=public
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-changeme_in_production}
      - NEXT_PUBLIC_SOCKET_URL=http://localhost:3001
      - JUDGE_SERVICE_URL=http://judge:3000
    develop:
      watch:
        - action: sync
          path: ./web
          target: /app
          ignore:
            - node_modules/
        - action: rebuild
          path: ./web/package.json

    depends_on:
      - postgres
      - judge
      - socket

  socket:
    build: ./socket-service
    container_name: codellab-socket
    restart: always
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-codellab}:${POSTGRES_PASSWORD:-codellab_password}@postgres:5432/${POSTGRES_DB:-codellab}?schema=public
    depends_on:
      - postgres

  judge:
    build: ./judge-service
    container_name: codellab-judge
    restart: always
    ports:
      - "2358:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/codellab-execution:/tmp/codellab-execution
    depends_on:
      - judge-images

  judge-images:
    image: alpine:latest
    command: >
      sh -c "
      echo 'Pulling judge images...' &&
      apk add --no-cache docker-cli &&
      docker pull node:20-alpine &&
      docker pull python:3.9-alpine &&
      docker pull openjdk:17-jdk-alpine &&
      docker pull gcc:latest &&
      echo 'Judge images pulled successfully.'
      "
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  postgres-data:
