"use client"
import { useState, useEffect, useRef } from "react"
import { ChatPanel } from "@/components/chat-panel"
import { ParticipantList } from "@/components/participant-list"
import { useWebSocket } from "@/hooks/use-websocket"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog"
import {
  FileText,
  Plus,
} from "lucide-react"
import { DockviewReact, DockviewApi, themeReplit } from "dockview"
import 'dockview/dist/styles/dockview.css'
import "@/app/leetcode-dockview.css"
import { WebSocketProvider } from "@/context/WebSocketProvider"
import { useCodeCoordinator } from "@/hooks/useCodeCoordinator";
import { useDockRefStore } from "@/stores/dock-ref-store";
import { EditorPanel } from "./EditorPanel";
import { OutputPanel } from "./OutputPanel";
import { ConsolePanel } from "./ConsolePanel";
import Header from "./Header";
import { CustomTab } from "@/components/custom-tabs";
import { BlockNoteEditor } from '@/components/block-note-editor'
import { Whiteboard } from '@/components/drawing'
interface Participant {
  id: string
  username: string
  color: string
  isOnline: boolean
  role: "reader" | "writer" | "admin"
  cursor?: { x: number; y: number }
}

interface CollaborativeEditorProps {
  roomId: string
  roomName: string
  questionId?: string
  initialParticipants: Participant[]
  initialFiles: Array<{ name: string; language: string; content: string }>
  currentUserId: string
  currentUsername: string
  onCodeChange?: (code: string) => void
}

/* ---------------- Utilities ---------------- */

// Generate a consistent color from a user ID
function getUserColor(userId: string): string {
  const colors = [
    "#3b82f6", // blue
    "#10b981", // green
    "#8b5cf6", // purple
    "#f59e0b", // orange
    "#ec4899", // pink
    "#6366f1", // indigo
    "#14b8a6", // teal
    "#f97316", // deep orange
  ]

  // Handle undefined, null, or empty userId
  if (!userId || userId.length === 0) {
    return colors[0] // Return default color
  }

  // Simple hash function to get consistent color for userId
  let hash = 0
  for (let i = 0; i < userId.length; i++) {
    hash = userId.charCodeAt(i) + ((hash << 5) - hash)
  }

  const index = Math.abs(hash) % colors.length
  return colors[index]
}

/* ---------------- Dockview Panels ---------------- */

function SidebarPanel({ params }: any) {
  const {
    type,
    files,
    activeFile,
    setActiveFile,
    handleCreateFile,
    participants,
    currentUserId,
    roomId,
    currentUsername,
    userColor,
  } = params || {}
  if (type === "files") {
    return (
      <Card className="h-full flex flex-col">
        <CardHeader className="pb-2">
          <div className="flex justify-between">
            <CardTitle className="text-sm">Files</CardTitle>
            <Dialog>
              <DialogTrigger asChild>
                <Button size="icon" variant="ghost">
                  <Plus className="h-4 w-4" />
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Create File</DialogTitle>
                </DialogHeader>
                <Input
                  onKeyDown={(e) =>
                    e.key === "Enter" &&
                    handleCreateFile(e.currentTarget.value)
                  }
                />
              </DialogContent>
            </Dialog>
          </div>
        </CardHeader>

        <CardContent className="flex-1 overflow-auto space-y-2">
          {files.map((file: any) => (
            <button
              key={file.name}
              onClick={() => setActiveFile(file.name)}
              className={`w-full text-left px-2 py-1 rounded ${activeFile === file.name
                ? "bg-primary/10 text-primary"
                : "hover:bg-muted"
                }`}
            >
              <FileText className="inline mr-2 h-3 w-3" />
              {file.name}
            </button>
          ))}
        </CardContent>
      </Card>
    )
  }

  if (type === "participants") {
    return (
      <ParticipantList
      />
    )
  }

  if (type === "chat") {
    return (
      <ChatPanel
      />
    )
  }
  if (type === "note") {
    return (
      <BlockNoteEditor
        roomId={roomId}
        userId={currentUserId}
        username={currentUsername}
        userColor={userColor || getUserColor(currentUserId)}
      />
    )
  }
  if (type === "whiteboard") {
    return (<Whiteboard />)
  }
  return <>this is null</>
}
/* ---------------- Main Component ---------------- */
export function CollaborativeEditor({
  roomId,
  roomName,
  questionId,
  initialParticipants,
  initialFiles,
  currentUserId,
  currentUsername,
}: CollaborativeEditorProps) {
  /* =========================
    FILE STATE (SOURCE OF TRUTH)
    ========================= */

  const [files, setFiles] = useState<{ name: string; language: string; content: string }[]>(
    initialFiles.length
      ? initialFiles
      : [
        {
          name: "main.js",
          language: "javascript",
          content: "// Main solution file",
        },
      ]
  )

  const [activeFile, setActiveFile] = useState(
    initialFiles[0]?.name ?? "main.js"
  )

  /* =========================
     DOCKVIEW
     ========================= */

  const dockviewRef = useRef<DockviewApi | null>(null)

  const { setDockviewRef } = useDockRefStore()
  const handleCreateFile = async (name: string) => {
    const res = await fetch(`/api/rooms/${roomId}/files`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
    })

    if (!res.ok) return

    const newFile = await res.json()
    setFiles(prev => [...prev, newFile])
    setActiveFile(newFile.name)
  }
  const saveLayout = (api: DockviewApi) => {
    const layout = api.toJSON()
    localStorage.setItem("dockview-layout", JSON.stringify(layout))
  }

  return (
    <WebSocketProvider
      roomId={roomId}
      userId={currentUserId}
      username={currentUsername}
    >
      <div className="h-screen flex flex-col overflow-hidden">
        <Header roomId={roomId} roomName={roomName} />
        <div className="flex-1 overflow-hidden">
          <DockviewReact
            className="h-full"
            components={{
              sidebar: SidebarPanel,
              editor: ({ params }) => <EditorPanel {...params} />,
              output: ({ params }) => <OutputPanel {...params} />,
              console: ({ params }) => <ConsolePanel {...params} />,
            }}
            tabComponents={{
              default: CustomTab
            }}
            onReady={(event) => {
              const api = event.api
              dockviewRef.current = api;

              // Global params that all panels should have access to
              const globalParams = {
                roomId,
                currentUserId,
                currentUsername,
                userColor: getUserColor(currentUserId),
              }

              const saved = localStorage.getItem("dockview-layout");
              if (saved) {
                api.fromJSON(JSON.parse(saved))

                // Inject global params into all restored panels
                api.panels.forEach(panel => {
                  panel.api.updateParameters({
                    ...panel.params,
                    ...globalParams,
                  })
                })
              } else {
                api.addPanel({
                  tabComponent: "default",
                  id: "files",
                  component: "sidebar",
                  title: "files",
                  minimumHeight: 45,
                  initialHeight: 45,
                  initialWidth: 45,
                  minimumWidth: 45,
                  params: {
                    type: "files",
                    files,
                    activeFile,
                    setActiveFile,
                    handleCreateFile,
                  },
                })
                api.addPanel({
                  tabComponent: "default",
                  id: "participants",
                  component: "sidebar",
                  title: "Participants",
                  minimumHeight: 45,
                  initialHeight: 45,
                  initialWidth: 45,
                  minimumWidth: 45,
                  position: { referencePanel: "files", direction: "within" },
                  params: {
                    type: "participants"
                  }
                })
                api.addPanel({
                  tabComponent: "default",
                  id: "chat",
                  component: "sidebar",
                  title: "Chat",
                  minimumHeight: 45,
                  initialWidth: 45,
                  minimumWidth: 45,
                  initialHeight: 45,
                  position: { referencePanel: "files", direction: "within" },
                  params: {
                    type: "chat"
                  }
                }),

                  api.addPanel({
                    tabComponent: "default",
                    id: "editor",
                    component: "editor",
                    title: "Code",
                    minimumHeight: 45,
                    initialHeight: 45,
                    minimumWidth: 500,
                    initialWidth: 1250,
                    position: {
                      referencePanel: "files",
                      direction: "right",
                    },
                    params: {
                      type: "editor",
                      roomId: roomId,
                      currentUserId,
                      currentUsername,
                    },
                  }),

                  api.addPanel({
                    tabComponent: "default",
                    id: "output",
                    component: "output",
                    title: "Output",
                    minimumHeight: 45,
                    initialHeight: 45,
                    position: { referencePanel: "editor", direction: "below" },
                    params: {
                      type: "output",
                    },
                  })
                api.addPanel({
                  tabComponent: "default",
                  id: "console",
                  component: "console",
                  title: "Console",
                  minimumHeight: 45,
                  initialHeight: 45,
                  position: { referencePanel: "output", direction: "within" },
                  params: {
                    type: "console",
                  },
                  inactive: true,
                })
              }
              api.onDidLayoutChange(() => {
                saveLayout(api)
              })
              setTimeout(() => {
                setDockviewRef(api)
              }, 0)
            }}
            theme={
              {
                ...themeReplit,
                gap: 3
              }
            }
          />
        </div>
      </div>
    </WebSocketProvider>
  )
}


/* ---------------- Dockview Layout Setup ---------------- */

function setupLayout(api: any, config) {
  const { 
    files, 
    activeFile, 
    setActiveFile, 
    handleCreateFile, 
    roomId, 
    currentUserId, 
    currentUsername, 
    questionId, 
    testCases,
    getUserColor
  } = config;

  // Add sidebar panels
  api.addPanel({
    tabComponent: "default",
    id: "files",
    component: "sidebar",
    title: "files",
    minimumHeight: 45,
    initialHeight: 45,
    initialWidth: 45,
    minimumWidth: 45,
    params: {
      type: "files",
      files,
      activeFile,
      setActiveFile,
      handleCreateFile,
    },
  });
  api.addPanel({
    tabComponent: "default",
    id: "participants",
    component: "sidebar",
    title: "Participants",
    minimumHeight: 45,
    initialHeight: 45,
    initialWidth: 45,
    minimumWidth: 45,
    position: { referencePanel: "files", direction: "within" },
    params: {
      type: "participants"
    }
  });
  api.addPanel({
    tabComponent: "default",
    id: "chat",
    component: "sidebar",
    title: "Chat",
    minimumHeight: 45,
    initialWidth: 45,
    minimumWidth: 45,
    initialHeight: 45,
    position: { referencePanel: "files", direction: "within" },
    params: {
      type: "chat"
    }
  });

  if (questionId) {
    // Add problem description panel to the left of the editor
    api.addPanel({
      tabComponent: "default",
      id: "problem-description",
      component: "problem-description",
      title: "Problem",
      minimumWidth: 300,
      initialWidth: 400,
      position: { referencePanel: "files", direction: "right" },
      params: {
        type: "problem-description",
        roomId,
        questionId,
      },
    });

    // Add editor panel next to the problem description
    api.addPanel({
      tabComponent: "default",
      id: "editor",
      component: "editor",
      title: "Code",
      minimumHeight: 45,
      minimumWidth: 500,
      initialWidth: 800,
      position: {
        referencePanel: "problem-description",
        direction: "right",
      },
      params: {
        type: "editor",
        roomId: roomId,
        currentUserId,
        currentUsername,
        questionId,
        testCases,
      },
    });

    // Add test cases panel below the editor
    api.addPanel({
      tabComponent: "default",
      id: "testcases",
      component: "testcases",
      title: "Test Cases",
      minimumHeight: 45,
      position: { referencePanel: "editor", direction: "below" },
      params: {
        type: "testcases",
        roomId,
        questionId,
        testCases,
      },
    });

    // Add console panel below test cases
    api.addPanel({
      tabComponent: "default",
      id: "console",
      component: "console",
      title: "Console",
      minimumHeight: 45,
      position: { referencePanel: "testcases", direction: "within" },
      params: {
        type: "console",
      },
      inactive: true,
    });
  } else {
    // Default panels when not in question mode
    api.addPanel({
      tabComponent: "default",
      id: "editor",
      component: "editor",
      title: "Code",
      minimumHeight: 45,
      initialHeight: 45,
      minimumWidth: 500,
      initialWidth: 1250,
      position: {
        referencePanel: "files",
        direction: "right",
      },
      params: {
        type: "editor",
        roomId: roomId,
        currentUserId,
        currentUsername,
      },
    });

    api.addPanel({
      tabComponent: "default",
      id: "output",
      component: "output",
      title: "Output",
      minimumHeight: 45,
      initialHeight: 45,
      position: { referencePanel: "editor", direction: "below" },
      params: {
        type: "output",
      },
    });
    api.addPanel({
      tabComponent: "default",
      id: "console",
      component: "console",
      title: "Console",
      minimumHeight: 45,
      initialHeight: 45,
      position: { referencePanel: "output", direction: "within" },
      params: {
        type: "console",
      },
      inactive: true,
    });
  }
}
